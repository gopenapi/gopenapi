# Gopenapi
Gopenapi helps you write the openapi spec, help you get rid of the cumbersome definition and keep it as flexible as the native yaml syntax.

## Goals

- Highly flexible
  - Base on openapi.yaml file, you can choose which part of the content is generated by Gopenapi according to your preferences
  - Use JavaScript to write additional logic
- Understanding low-cost
  - Syntax as simple as yaml
- Less intrusion
  - Just need a few comments in the go source code
  
## Why not

- [go-swagger](https://github.com/go-swagger/go-swagger) has the following disadvantages:
  - Syntax is complicated, I now need to learn two kinds of syntax: openapi and goswagger
  - Non-scalability, only the syntax supported by go-swgger can be used
  - It maks the source code is not clean enough, as time advances, the source code will become more and more verbose

## Shortcoming
- Currently, this project is still being tested, Performance is not stable enough, code is not elegant enough.
- Since it is based on Golang Ast, it currently only supports the Golang.

## Get it!

### Precondition
- Make sure your project is written in Golang
- Make sure 'go module' is enabled
- Make sure the 'go.mod' file is in the project root directory

### Step 0: Install Gopenapi
```shell
go get -u github.com/gopenapi/gopenapi
```

### Step 1: Write openapi.src.yaml file
> Gopenapi only support yaml format files so far

```yaml
openapi: 3.0.1
info:
  title: Swagger Petstore
  description: |
    This is a sample server Petstore server.  You can find out more about     Swagger
    at [http://swagger.io](http://swagger.io) or on [irc.freenode.net, #swagger](http://swagger.io/irc/).      For
    this sample, you can use the api key "special-key" to test the authorization     filters.

    **All api maybe return 401 code if it need auth.**
  termsOfService: http://swagger.io/terms/
  contact:
    email: apiteam@swagger.io
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
  version: 1.0.0
externalDocs:
  description: Find out more about Swagger
  url: http://swagger.io
servers:
  - url: https://petstore.swagger.io/v2
  - url: http://petstore.swagger.io/v2

tags:
  - name: pet
    description: Test all features

paths:
  /pet/findByStatus:
    get:
      x-$path: github.com/gopenapi/gopenapi/internal/delivery/http/handler.PetHandler.FindPetByStatus
      tags:
        - pet
      security:
        - petstore_auth:
            - write:pets
            - read:pets
  /pet/{id}:
    get:
      x-$path: github.com/gopenapi/gopenapi/internal/delivery/http/handler.PetHandler.GetPet
      tags:
        - pet
      operationId: getPetById
      security:
        - api_key: [ ]

    delete:
      x-$path: ./internal/delivery/http/handler.PetHandler.DelPet
      tags:
        - pet
      security:
        - api_key: [ ]

components:
  schemas:
    Category:
      x-$schema: github.com/gopenapi/gopenapi/internal/model.Category
    Tag:
      x-$schema: ./internal/model.Tag
    Pet:
      x-$schema: github.com/gopenapi/gopenapi/internal/model.Pet
```

As you can see, Gopenapi provide some extended syntax:
- x-$schema
- x-$path

#### x-$path
Its value is the definition path of go type(function or struct). 

e.g.
- github.com/gopenapi/gopenapi/internal/delivery/http/handler.PetHandler.FindPetByStatus
- ./internal/delivery/http/handler.PetHandler.FindPetByStatus

#### x-$schema
Its value is the definition path of go struct.

e.g.
- github.com/gopenapi/gopenapi/internal/model.Pet
- ./internal/model.Pet

### Step 2: Write same 'meta-comments' in your go source code

```go
// FindPetByStatus Finds Pets by status
//
// $:
//   params: model.FindPetByStatusParams
//   response: schema([model.Pet])
func (h *PetHandler) FindPetByStatus(ctx *gin.Context) {
	...
}
```

'meta-comments' syntax is yaml, but it needs to start with the '$' symbol.

The following syntax is correct:
```
// $:
//   params: model.FindPetByStatusParams
//   response: schema([model.Pet])
```
or
```
// $:
//   params: model.FindPetByStatusParams
//   response: 
//     200: schema([model.Pet])
```
or
```
// $params: model.FindPetByStatusParams
// $response: schema([model.Pet])
```

> Remember it just is 'yaml'

### Step 3: Run Gopenapi to fill your yaml file

```bash
gopenapi -i example/openapi.src.yaml -o example/openapi.gen.yaml
```

You can type 'gopenapi -h' to get helps. 
```bash
gopenapi -h
```

> Tip: You can review the generated file on http://editor.swagger.io/

## FQA

#### How to distinguish whether the string in 'meta-comments' is JavaScript or pure string?

```
// $:
//   params: model.FindPetByStatusParams
```

In the above example, 'model.FindPetByStatusParams' will be parsed into JavaScript execution instead of pure string, because Gopenapi can guessing whether the string is JavaScript or not.

Strings that meet the following rules will be executed as JavaScript:
- Wrap with '[]'
- Wrap with '{}'
- Wrap with 'schema()'
- string like "model.X" and can find the definition in go source code.
